<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<!--edge浏览器H5兼容设置-->
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<!--360浏览器H5兼容设置-->
	<meta name="renderer" content="webkit" />
	<title>手机商城</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!--导入核心文件-->
	<script src="../bootstrap3/js/holder.js"></script>
	<link href="../bootstrap3/css/bootstrap.css" rel="stylesheet" type="text/css">
	<script src="../bootstrap3/jquery-1.9.1.min.js"></script>
	<script src="../bootstrap3/js/bootstrap.js"></script>
	<!-- 字体图标 -->
	<link rel="stylesheet" href="../bootstrap3/font-awesome-4.7.0/css/font-awesome.css" />
	<link rel="stylesheet" type="text/css" href="../css/layout.css" />
	<link rel="stylesheet" type="text/css" href="../css/top.css" />
	<link rel="stylesheet" type="text/css" href="../css/footer.css" />
	<link rel="stylesheet" type="text/css" href="../css/orderInfo.css" />
	<link rel="stylesheet" type="text/css" href="../css/order.css" />
	<script src="../js/herf.js" type="text/javascript" charset="UTF-8"></script>
	<script src="../js/TimeTran.js" type="text/javascript" charset="UTF-8"></script>

	<script type="text/javascript">
		// 在原时间基础上添加几天
		function addDate(oldDate, days) {
			let newDate = new Date(oldDate);
			let today = newDate.getDate();
			newDate = newDate.setDate(today + days);
			return newDate;
		}

		// 查询订单信息
		function showOrder(oid) {
			$.ajax({
				url: "/order/queryOrderVo",
				type: "get",
				data: "oid=" + oid,
				dataType: "json",
				success: function (res) {
					let tempOrder = res.data[0];
					// 转换时间
					let order = getDate(tempOrder.orderTime);
					let pay = getDate(tempOrder.payTime);
					let sendTime = addDate(tempOrder.orderTime, 1);
					let send = getDate(sendTime);
					let ensureTime = addDate(tempOrder.orderTime, 3);
					let ensure = getDate(ensureTime);

					// 修改状态信息
					$("#orderVoId").html(tempOrder.oid);

					let orderStatus = JSON.parse(tempOrder.status);
					if (orderStatus === -1) {
						$("#orderStatus").html("已取消");
						$("li").removeClass("order-success");
						$("span").removeClass("fa fa-check-circle");
						$("#tranInfo").empty().html("<p style='font-size: larger'>无</p>");
					} else if (orderStatus === 0) {
						$("#orderStatus").html("未付款");
						$("li").removeClass("order-success");
						$("span").removeClass("fa fa-check-circle");
						$("#tranInfo").empty().html("<p style='font-size: larger'>无</p>");
					} else if (orderStatus === 1) {
						$("#orderStatus").html("已付款");
						$("#orderTime").html(order);
						$("#payTime").html(pay);
						$(".order-flow").children("li:eq(2)").removeClass("order-success");
						$(".order-flow").find("li:eq(2)").children("span").removeClass("fa fa-check-circle");
						$("#tranInfo").empty().html("<p style='font-size: larger'>无</p>");
					} else if (orderStatus === 2) {
						$("#orderStatus").html("待收货");
						$("#orderTime").html(order);
						$("#payTime").html(pay);
						$("#sentTime").html(send);
					} else if (orderStatus === 3) {
						$("#orderStatus").html("已收货");
						$("#orderTime").html(order);
						$("#payTime").html(pay);
						$("#sentTime").html(send);
						$("#ensureTime").html(ensure);
						$(".order-flow").children("li:eq(3)").addClass("order-success");
						$(".order-flow").find("li:eq(3)").append("<span class='fa fa-check-circle'></span>");
					} else if (orderStatus === 4) {
						$("#orderStatus").html("已完成");
						$("#orderTime").html(order);
						$("#payTime").html(pay);
						$("#sentTime").html(send);
						$("#ensureTime").html(ensure);
						$(".order-flow li").addClass("order-success");
						$(".order-flow li").each(function () {
							if ($(this).find("span.fa-check-circle").length === 0) {
								$(this).append("<span class='fa fa-check-circle'></span>");
							}
						});
					}

					// 修改地址详情
					$("#recvName").html(tempOrder.recvName);
					$("#zip").html(tempOrder.zip);
					$("#phone").html(tempOrder.phone);
					$("#address").html(tempOrder.provinceName + tempOrder.cityName + tempOrder.areaName + tempOrder.address);

					// 修改商品详情
					$("#orderVoId2").html(tempOrder.oid);
					$("#orderTime2").html(order);
					$("#recvName2").html(tempOrder.recvName);

					// 添加“操作”列到表头（仅当状态为3或4时）
					if (orderStatus === 3 || orderStatus === 4) {
						$(".orders-table thead tr").append("<th width='10%'>操作</th>");
					}

					// 遍历商品并添加到表格
					for (let i = 0; i < res.data.length; i++) {
						let orderVo = res.data[i];
						console.log("OrderVo PID:", orderVo.pid); // 调试 pid 值
						let str = "<tr>" +
								"<td><img src=.." + orderVo.image + "1.jpg class='img-responsive' /></td>" +
								"<td>" + orderVo.title + "</td>" +
								"<td>¥<span>" + orderVo.price + "</span></td>" +
								"<td>" + orderVo.num + "</td>" +
								"<td>¥<span>" + orderVo.price * orderVo.num + "</span></td>";

						// 检查该商品是否已评价
						let hasComment = false;
						$.ajax({
							url: "/comment/" + orderVo.pid,
							type: "get",
							async: false, // 同步请求以确保 hasComment 被正确设置
							dataType: "json",
							success: function (commentRes) {
								for (let comment of commentRes.data) {
									if (comment.oid === tempOrder.oid) {
										hasComment = true;
										break;
									}
								}
							}
						});

						if (orderStatus === 3 && !hasComment) {
							str += `<td><button class='btn btn-primary btn-xs comment-btn' data-pid='${orderVo.pid}' data-oid='${tempOrder.oid}'>评价</button></td>`;
						} else if (orderStatus === 3 && hasComment || orderStatus === 4) {
							str += "<td><button class='btn btn-primary btn-xs comment-btn' disabled>已评价</button></td>";
						} else {
							str += "<td></td>";
						}

						str += "</tr>";
						$(".orders-body").append(str);
					}

					// 修改订单总金额
					$("#totalPrice").html(tempOrder.totalPrice);
				},
				error: function (error) {
					alert("服务器出现故障，请等待攻城狮修复！！");
				}
			});
		}

		// 处理评价按钮点击
		$(document).on("click", ".comment-btn", function() {
			let pid = $(this).data("pid");
			let oid = $(this).data("oid");

			// 创建评价弹窗
			let commentForm = `<!-- 评价弹窗 -->
<div id="commentModal" style="position: fixed; top: 20%; left: 50%; transform: translateX(-50%); background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); z-index: 1000; width: 400px;">
    <h3 style="text-align: center; font-size: 22px; color: #333;">商品评价</h3>
    <form id="commentForm" style="display: flex; flex-direction: column; gap: 15px;">
        <label for="rating" style="font-size: 16px; color: #555;">评分:</label>
        <select id="rating" name="rating" required style="padding: 8px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc;">
            <option value="" disabled selected>请选择评分</option>
            <option value="1">1 分</option>
            <option value="2">2 分</option>
            <option value="3">3 分</option>
            <option value="4">4 分</option>
            <option value="5">5 分</option>
        </select>
        <label for="content" style="font-size: 16px; color: #555;">评价内容:</label>
        <textarea id="content" rows="4" cols="50" required style="padding: 10px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc;"></textarea>
        <div style="display: flex; justify-content: space-between;">
            <button type="button" id="submitComment" style="background-color: #4CAF50; color: white; padding: 10px 20px; font-size: 16px; border-radius: 5px; border: none; cursor: pointer; transition: background-color 0.3s;">提交</button>
            <button type="button" id="cancelComment" style="background-color: #f44336; color: white; padding: 10px 20px; font-size: 16px; border-radius: 5px; border: none; cursor: pointer; transition: background-color 0.3s;">取消</button>
        </div>
    </form>
</div>`;
			$("body").append(commentForm);

			// 提交评价
			$("#submitComment").click(function() {
				let rating = $("#rating").val();
				let content = $("#content").val();
				let uid = sessionStorage.getItem("uid");

				if (!rating || !content) {
					alert("请填写评分和评价内容！");
					return;
				}

				$.ajax({
					url: "/comment/add",
					type: "post",
					contentType: "application/json",
					data: JSON.stringify({
						oid: oid,
						pid: pid,
						content: content,
						rating: rating
					}),
					dataType: "json",
					success: function(res) {
						// 检查是否返回错误状态（例如重复评价）
						if (res.code === 400) {
							alert("该商品已评价，无法重复评价！");
							$("#commentModal, #overlay").remove();
							return;
						}

						alert("评价提交成功！");
						$("#commentModal, #overlay").remove();
						// 禁用评价按钮
						$(`button[data-pid="${pid}"][data-oid="${oid}"]`).prop("disabled", true).text("已评价");

						// 重新加载订单信息以更新状态
						$.ajax({
							url: "/order/queryOrderVo",
							type: "get",
							data: "oid=" + oid,
							dataType: "json",
							success: function (res) {
								let tempOrder = res.data[0];
								let orderStatus = JSON.parse(tempOrder.status);
								if (orderStatus === 4) {
									$("#orderStatus").html("已完成");
									$(".order-flow li").addClass("order-success");
									$(".order-flow li").each(function () {
										if ($(this).find("span.fa-check-circle").length === 0) {
											$(this).append("<span class='fa fa-check-circle'></span>");
										}
									});
									// 更新商品表格，显示“已评价”
									$(".orders-body tr").each(function() {
										let button = $(this).find(".comment-btn");
										if (button.length > 0) {
											$(this).find("td:last").html("已评价");
										}
									});
								}
							}
						});
					},
					error: function(err) {
						alert("提交评价失败！");
					}
				});
			});

			// 取消评价
			$("#cancelComment").click(function() {
				$("#commentModal, #overlay").remove();
			});
		});

			$(function () {
				// 引入公共头部、中间导航条以及页脚
				$(".header").load("components/head.html");
				$(".footer").load("components/footer.html");
				$(".middleNavigation").load("components/middleNavigationBar.html");
				// 获取从上个页面传来的oid参数
				let oid = getPidFromLastHtml();

				// 自动发送ajax请求查询订单信息
				showOrder(oid);
			});
	</script>
</head>

<body>
<!--头部开始-->
<div class="header"></div>
<!--头部结束-->

<!--中间导航条开始 -->
<div class="middleNavigation"></div>
<!--中间导航条结束-->

<!--页面主体开始-->
<div class="container">
	<div class="col-md-offset-1 col-md-10">
		<h1>订单详情：</h1>
		<h2 class="page-header">状态信息：</h2>
		<div class="state-bar">
			订单号：<span id="orderVoId"></span> ，
			当前状态：<span id="orderStatus"></span>
		</div>
		<ol class="order-flow">
			<li class="order-success">1.提交订单 <small id="orderTime"></small> <span class="fa fa-check-circle"></span></li>
			<li class="order-success">2.付款成功 <small id="payTime"></small> <span class="fa fa-check-circle"></span></li>
			<li class="order-success">3.商城发货 <small id="sentTime"></small> <span class="fa fa-check-circle"></span></li>
			<li>4.用户收货 <small id="ensureTime"></small> </li>
			<li>5.购物评价</li>
		</ol>
		<h2 class="page-header">地址详情：</h2>
		<p>收货人姓名：<span id="recvName"></span>，
			邮政编码：<span id="zip"></span>，
			联系电话：<span id="phone"></span>
		</p>
		<p>收货地址：<span id="address"></span></p>
		<h2 class="page-header">物流信息：</h2>
		<div id="tranInfo">
			<p>发货时间：2024-07-23 14:09</p>
			<p>物流公司：顺丰快递</p>
			<p>快递单号：301111303203048</p>
			<p>物流信息：</p>
			<p>2024-07-24 18:09:30 您的快递在【xx国贸分拣中心】准备装车</p>
			<p>2024-07-25 08:39:50 您的快递在【xx转运中心】分拣完毕</p>
			<p>2024-07-25 23:18:07 您的快递到达【xx派发中心】</p>
		</div>

		<h2 class="page-header">商品详情：</h2>
		<div class="panel panel-default">
			<div class="panel-heading">
				<h3 class="panel-title">
					订单号：<span id="orderVoId2"></span>，
					下单时间：<span id="orderTime2"></span> ，
					收货人：<span id="recvName2"></span>
				</h3>
			</div>
			<div class="panel-body">
				<table class="orders-table">
					<thead>
					<tr>
						<th width="15%"></th>
						<th width="35%">商品</th>
						<th width="15%">单价</th>
						<th width="15%">数量</th>
						<th width="20%">小计</th>
					</tr>
					</thead>
					<tbody class="orders-body">
					<!--待填充内容-->
					</tbody>
				</table>
				<div>
					<span class="pull-right">订单总金额：¥<span id="totalPrice"></span></span>
				</div>
			</div>
		</div>
		<a href="orders.html">返回</a>
	</div>
</div>

<div class="clearfix"></div>
<!--页脚开始-->
<div class="footer"></div>
<!--页脚结束-->

<script>
	(function() {
		function c() {
			var b = a.contentDocument || a.contentWindow.document;
			if (b) {
				var d = b.createElement('script');
				d.innerHTML = "window.__CF$cv$params={r:'9314921e4a2082f3',t:'MTc0NDgxNTgyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
				b.getElementsByTagName('head')[0].appendChild(d);
			}
		}
		if (document.body) {
			var a = document.createElement('iframe');
			a.height = 1;
			a.width = 1;
			a.style.position = 'absolute';
			a.style.top = 0;
			a.style.left = 0;
			a.style.border = 'none';
			a.style.visibility = 'hidden';
			document.body.appendChild(a);
			if ('loading' !== document.readyState) c();
			else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c);
			else {
				var e = document.onreadystatechange || function() {};
				document.onreadystatechange = function(b) {
					e(b);
					'loading' !== document.readyState && (document.onreadystatechange = e, c());
				};
			}
		}
	})();
</script>
</body>
</html>